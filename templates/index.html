<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player - Inicio</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- VIDEO DE FONDO -->
    <video autoplay muted loop id="bg-video">
        <source src="{{ url_for('static', filename='video/fondo.mp4') }}" type="video/mp4">
    </video>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h2>MusicApp</h2>
            <ul>
                <li class="active"><a href="{{ url_for('index') }}">Inicio</a></li>
                <li><a href="{{ url_for('playlists') }}">Playlists</a></li>
                <li><a href="{{ url_for('favoritos') }}">Favoritos</a></li>
                <li><a href="{{ url_for('mi_playlist_page') }}">Mi Playlist</a></li>  
            </ul>
        </aside>

        <!-- Contenido Principal -->
        <main class="main-content">
            <h1>Descubre M√∫sica Nueva</h1>

            <!-- Nuevos lanzamientos -->
            <section class="new-releases">
                <h2>Nuevos Lanzamientos</h2>
                <div class="release-grid">
                    {% for album in lanzamientos %}
                    <div class="release-card" onclick="playAlbum('{{ album.id }}')">
                        <img src="{{ album.images[0].url if album.images else url_for('static', filename='img/placeholder.png') }}" alt="{{ album.name }}">
                        <h3>{{ album.name }}</h3>
                        <p>{{ album.artists[0].name }}</p>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </main>
    </div>

    <!-- Reproductor Global -->
    <div class="player-container">
        <div class="player">
            <!-- Informaci√≥n de la canci√≥n -->
            <div class="song-info">
                <div class="cover-container">
                    <video autoplay muted loop id="cover-video" style="display:none;">
                        <source src="{{ url_for('static', filename='video/vinilo.mp4') }}" type="video/mp4">
                    </video>
                    <img id="cover" src="{{ url_for('static', filename='img/placeholder.png') }}" alt="cover" style="display:none;">
                </div>
                <div class="track-info">
                    <h2 id="song-title">Nada reproduci√©ndose</h2>
                    <p id="song-artist">Selecciona una canci√≥n</p>
                </div>
                <button id="fav-btn" class="heart-btn" onclick="toggleFavorito()">‚ù§Ô∏è</button>
            </div>

            <!-- Controles centrales -->
            <div class="player-center">
                <div class="controls">
                    <button onclick="prev()">‚èÆ</button>
                    <button id="play-pause" onclick="togglePlay()">‚ñ∂</button>
                    <button onclick="next()">‚è≠</button>
                </div>
                <div class="progress-container">
                    <span id="current-time">0:00</span>
                    <input type="range" id="progress-bar" value="0" min="0" max="100">
                    <span id="total-time">0:00</span>
                </div>
            </div>

            <!-- Extras -->
            <div class="player-extras">
                <!-- Aqu√≠ puedes agregar controles de volumen si lo deseas -->
            </div>
        </div>
    </div>

    <script>
        let currentTrackId = null;
        let duration = 0;
        let isPlaying = false;

        async function loadCurrentTrack() {
            try {
                const res = await fetch("/current");
                const data = await res.json();

                document.getElementById("song-title").textContent = data.trackTitle || "Nada reproduci√©ndose";
                document.getElementById("song-artist").textContent = data.trackArtist || "Selecciona una canci√≥n";

                currentTrackId = data.trackId;
                duration = data.duration || 0;

                const coverVideo = document.getElementById("cover-video");
                const coverImg = document.getElementById("cover");

                if (data.coverUrl) {
                    coverVideo.style.display = "none";
                    coverImg.src = data.coverUrl;
                    coverImg.style.display = "block";
                } else {
                    coverVideo.style.display = "block";
                    coverImg.style.display = "none";
                }

                const favBtn = document.getElementById("fav-btn");
                if (data.isFavorite) {
                    favBtn.textContent = "üíî";
                    favBtn.classList.add("active");
                } else {
                    favBtn.textContent = "‚ù§Ô∏è";
                    favBtn.classList.remove("active");
                }

                const progressBar = document.getElementById("progress-bar");
                const currentTime = document.getElementById("current-time");
                const totalTime = document.getElementById("total-time");

                if (duration > 0) {
                    progressBar.max = duration;
                    progressBar.value = data.progress || 0;
                    currentTime.textContent = formatTime((data.progress || 0) / 1000);
                    totalTime.textContent = formatTime(duration / 1000);
                }

                isPlaying = data.trackId !== null;
                document.getElementById("play-pause").textContent = isPlaying ? "‚è∏" : "‚ñ∂";
            } catch (error) {
                console.error("Error cargando canci√≥n:", error);
            }
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s < 10 ? "0" : ""}${s}`;
        }

        async function togglePlay() {
            try {
                await fetch("/play");
                setTimeout(loadCurrentTrack, 500);
            } catch (error) {
                console.error("Error en play/pause:", error);
            }
        }

        async function next() {
            try {
                await fetch("/next");
                setTimeout(loadCurrentTrack, 500);
            } catch (error) {
                console.error("Error en next:", error);
            }
        }

        async function prev() {
            try {
                await fetch("/prev");
                setTimeout(loadCurrentTrack, 500);
            } catch (error) {
                console.error("Error en prev:", error);
            }
        }

        async function toggleFavorito() {
            if (!currentTrackId) return;
            
            try {
                const res = await fetch(`/toggle_favorito/${currentTrackId}`, { method: "POST" });
                const data = await res.json();
                
                const favBtn = document.getElementById("fav-btn");
                if (data.status === "added") {
                    favBtn.textContent = "üíî";
                    favBtn.classList.add("active");
                } else {
                    favBtn.textContent = "‚ù§Ô∏è";
                    favBtn.classList.remove("active");
                }
            } catch (error) {
                console.error("Error toggle favorito:", error);
            }
        }

        document.getElementById("progress-bar").addEventListener("input", async (e) => {
            const pos = e.target.value;
            try {
                await fetch(`/seek/${pos}`, { method: "POST" });
            } catch (error) {
                console.error("Error en seek:", error);
            }
        });

async function playAlbum(albumId) {
    console.log("[v0] Reproduciendo √°lbum:", albumId);
    
    try {
        const res = await fetch(`/play_album/${albumId}`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            console.log("[v0] √Ålbum reproducido exitosamente");
            setTimeout(loadCurrentTrack, 1000);
        } else {
            alert(data.message || "No se pudo reproducir el √°lbum");
        }
    } catch (error) {
        console.error("[v0] Error reproduciendo √°lbum:", error);
        alert("Error al reproducir. Aseg√∫rate de tener Spotify abierto.");
    }
}


        setInterval(loadCurrentTrack, 3000);
        loadCurrentTrack();
    </script>
</body>
</html>